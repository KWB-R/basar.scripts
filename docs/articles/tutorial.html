<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R Script Supporting the Creation of a Volume-Proportional Composite Sample • kwb.monitoring</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="R Script Supporting the Creation of a Volume-Proportional Composite Sample">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">kwb.monitoring</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/tutorial.html">R Script Supporting the Creation of a Volume-Proportional Composite Sample</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/KWB-R/kwb.monitoring">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>R Script Supporting the Creation of a Volume-Proportional Composite Sample</h1>
                        <h4 class="author">Hauke Sonnenberg</h4>
            
            <h4 class="date">2018-06-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/KWB-R/kwb.monitoring/blob/master/vignettes/tutorial.Rmd"><code>vignettes/tutorial.Rmd</code></a></small>
      <div class="hidden name"><code>tutorial.Rmd</code></div>

    </div>

    
    
<div id="install-required-packages" class="section level1">
<h1 class="hasAnchor">
<a href="#install-required-packages" class="anchor"></a>Install Required Packages</h1>
<p>In order to run the script you need a bunch of R packages all of which are are publicly available, either on <a href="http://cran.r-project.org/web/packages/available_packages_by_name.html">CRAN (Comprehensive R Archive Network)</a> or on <a href="https://github.com/kwb-r">our GitHub-Account</a>.</p>
<p>The script described in the following requires the package <a href="https://github.com/kwb-r/kwb.monitoring">kwb.monitoring</a> and all its dependencies. All these packages are automatically installed by running the following code. Make sure to have none of the packages to be installed already loaded.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Install devtools, if required, from CRAN</span>
<span class="co"># install.packages("devtools")</span>

<span class="co"># Install kwb.monitoring from GitHub</span>
devtools::<span class="kw">install_github</span>(<span class="st">"kwb-r/kwb.monitoring"</span>, <span class="dt">dependencies =</span> <span class="ot">TRUE</span>)</code></pre></div>
</div>
<div id="load-kwb-monitoring" class="section level1">
<h1 class="hasAnchor">
<a href="#load-kwb-monitoring" class="anchor"></a>Load kwb.monitoring</h1>
<p>We are now ready to start the actual script. First, you need to load the package kwb.monitoring and all the packages that it depends on:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(kwb.monitoring)</code></pre></div>
</div>
<div id="configuration" class="section level1">
<h1 class="hasAnchor">
<a href="#configuration" class="anchor"></a>Configuration</h1>
<p>We need to start with a configuration section that defines how the script will behave, depending on the monitoring station of which data is being analysed. We are using three letter codes to identify a monitoring station. Let’s assume that we have two monitoring stations: <strong>ALT</strong> and <strong>NEU</strong> (taken from KWB project <strong><a href="http://www.kompetenz-wasser.de/OgRe-Relevanz-organischer-Spurens.568.0.html">OGRE</a></strong> where they represent “Altbau” and “Neubau”). At both stations at least the water level and the flow are measured.</p>
<p>The code section printed in the following defines different types of settings:</p>
<ul>
<li><p><code>eventSettings</code> define for each monitoring station time intervals for which to apply different thresholds of water level and flow. In the example below two time windows are defined in each case but you are free to adapt the list for more or less time intervals. The event settings have the following effect: If for a timestamp belonging to the time interval between <code>tBeg</code> and <code>tEnd</code> the measured water level is above <code>Hthreshold</code> and the measured flow is above <code>Qthreshold</code>, then, and only then, this timestamp is considered to lie within a “hydraulic event”. The script will detect hydraulic events and will generate plots and statistics for each event.</p></li>
<li><p><code>regressionSettings</code> define which H/Q-regression models to use if flow data are lacking. Different models can be applied to different time intervals (sublist <code>models</code>). The sublist <code>usage</code> defines in which time intervals missing values are replaced by values that are predicted by the regression models rather than doing a linear interpolation (standard behaviour).</p></li>
<li><p><code>intervalsToRemove</code> defines time intervals of which data shall not be used for the analysis. These intervals are removed before showing the event overview plots so that these intervals will not be shown. Also, you will not be able to calculate any composite sampling for these intervals.</p></li>
<li><p><code>settings</code> defines diverse main settings that control the behaviour of the script. For an explanation of these settings, see the comments in the script below or the help page of the function <code><a href="../reference/configure.html">kwb.monitoring::configure</a></code>.</p></li>
</ul>
<div id="define-helper-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#define-helper-functions" class="anchor"></a>Define Helper Functions</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">as_utc &lt;-<span class="st"> </span>function(x) <span class="kw">as.POSIXct</span>(x, <span class="dt">tc =</span> <span class="st">"UTC"</span>)</code></pre></div>
</div>
<div id="define-event-settings" class="section level2">
<h2 class="hasAnchor">
<a href="#define-event-settings" class="anchor"></a>Define Event Settings</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># eventSettings ----------------------------------------------------------------</span>
eventSettings &lt;-<span class="st"> </span><span class="kw">list</span>(
  
  <span class="co">#Hthresholds = c(ALT = 0.07, NEU = 0.07), </span>
  <span class="co">#Qthresholds = c(ALT = 5, NEU = 2.5),</span>
  
  <span class="dt">ALT =</span> <span class="kw">rbind</span>(
    
    <span class="kw">data.frame</span>(
      <span class="dt">tBeg =</span> <span class="kw">as_utc</span>(<span class="st">"2014-03-27 10:04:00"</span>), 
      <span class="dt">tEnd =</span> <span class="kw">as_utc</span>(<span class="st">"2014-04-23 17:14:59"</span>), 
      <span class="dt">Hthreshold =</span> <span class="fl">0.07</span>, 
      <span class="dt">Qthreshold =</span> <span class="dv">2</span>
    ),
    
    <span class="kw">data.frame</span>(
      <span class="dt">tBeg =</span> <span class="kw">as_utc</span>(<span class="st">"2014-04-23 17:00:00"</span>), 
      <span class="dt">tEnd =</span> <span class="kw">as_utc</span>(<span class="st">"2014-04-23 21:01:00"</span>), 
      <span class="dt">Hthreshold =</span> <span class="fl">0.07</span>, 
      <span class="dt">Qthreshold =</span> <span class="dv">4</span>
    )
    
    <span class="co"># you may continue...</span>
    <span class="co"># , data.frame(...)</span>
  ),
  
  <span class="dt">NEU =</span> <span class="kw">rbind</span>(
    <span class="kw">data.frame</span>(
      <span class="dt">tBeg =</span> <span class="kw">as_utc</span>(<span class="st">"2014-01-01 00:00:00"</span>), 
      <span class="dt">tEnd =</span> <span class="kw">as_utc</span>(<span class="st">"2014-07-09 19:00:00"</span>), 
      <span class="dt">Hthreshold =</span> <span class="fl">0.07</span>, 
      <span class="dt">Qthreshold =</span> <span class="fl">2.5</span>
    ),
    
    <span class="kw">data.frame</span>(
      <span class="dt">tBeg =</span> <span class="kw">as_utc</span>(<span class="st">"2014-07-09 19:00:01"</span>), 
      <span class="dt">tEnd =</span> <span class="kw">as_utc</span>(<span class="st">"2014-07-09 22:00:00"</span>), 
      <span class="dt">Hthreshold =</span> <span class="fl">0.07</span>, 
      <span class="dt">Qthreshold =</span> <span class="dv">5</span>
    )
    
    <span class="co"># you may continue...</span>
    <span class="co"># , data.frame(...)</span>
  )
)</code></pre></div>
</div>
<div id="define-regression-settings" class="section level2">
<h2 class="hasAnchor">
<a href="#define-regression-settings" class="anchor"></a>Define Regression Settings</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># regressionSettings -----------------------------------------------------------</span>
<span class="co"># models: which model file is to be used within which time interval</span>
<span class="co"># usage: in which time intervals are the correlated values to be used</span>
<span class="co"># instead of the linearly interpolated values</span>
regressionSettings &lt;-<span class="st"> </span><span class="kw">list</span>(
  
  <span class="co"># Which regression models are to be used within different time intervals?</span>
  <span class="dt">models =</span> <span class="kw">list</span>(
    
    <span class="co"># ALT = rbind(</span>
    <span class="co">#   data.frame(from = "2000-01-01", </span>
    <span class="co">#              to = "2020-01-01", </span>
    <span class="co">#              modelFile = "ALT_01_regressionModel.txt")</span>
    <span class="co">#   ),</span>
    <span class="co"># </span>
    <span class="co"># NEU = rbind(</span>
    <span class="co">#   data.frame(from = "2014-03-01", </span>
    <span class="co">#              to = "2014-10-01", </span>
    <span class="co">#              modelFile = "NEU_01_regressionModel.txt"),</span>
    <span class="co">#   </span>
    <span class="co">#   data.frame(from = "2014-10-02", </span>
    <span class="co">#              to = "2015-02-05", </span>
    <span class="co">#              modelFile = "NEU_02_regressionMode.txt"),</span>
    <span class="co">#   </span>
    <span class="co">#   data.frame(from = "2015-02-06", </span>
    <span class="co">#              to = "2015-12-31", </span>
    <span class="co">#              modelFile = "March_to_october_NEU_regressionModel.txt")</span>
    <span class="co">#   )</span>
  ),
  
  <span class="co"># In which time intervals shall the regression models actually be applied?</span>
  <span class="dt">usage =</span> <span class="kw">list</span>(
    
    <span class="dt">ALT =</span> <span class="kw">rbind</span>(
      <span class="kw">data.frame</span>(<span class="dt">from =</span> <span class="st">"2015-01-30"</span>, <span class="dt">to =</span> <span class="st">"2015-02-01"</span>)
    ),
    
    <span class="dt">NEU =</span> <span class="kw">rbind</span>(
      <span class="kw">data.frame</span>(<span class="dt">from =</span> <span class="st">"2014-04-18"</span>, <span class="dt">to =</span> <span class="st">"2014-06-13"</span>),
      <span class="kw">data.frame</span>(<span class="dt">from =</span> <span class="st">"2014-07-09"</span>, <span class="dt">to =</span> <span class="st">"2014-08-31"</span>)
    )
  )
)</code></pre></div>
</div>
<div id="define-time-intervals-to-be-removed" class="section level2">
<h2 class="hasAnchor">
<a href="#define-time-intervals-to-be-removed" class="anchor"></a>Define Time Intervals to be Removed</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># intervalsToRemove ------------------------------------------------------------</span>
intervalsToRemove &lt;-<span class="st"> </span><span class="kw">list</span>(
  
  <span class="dt">ALT =</span> <span class="kw">list</span>(
    lubridate::<span class="kw">interval</span>(
      lubridate::<span class="kw">ymd_hm</span>(<span class="st">"2014-04-03 17:38"</span>), 
      lubridate::<span class="kw">ymd_hm</span>(<span class="st">"2014-04-03 18:12"</span>)
    ),
    lubridate::<span class="kw">interval</span>(
      lubridate::<span class="kw">ymd_hm</span>(<span class="st">"2014-04-04 12:00"</span>), 
      lubridate::<span class="kw">ymd_hm</span>(<span class="st">"2014-04-04 13:10"</span>)
    )
  ),
  
  <span class="dt">NEU =</span> <span class="kw">list</span>(
    lubridate::<span class="kw">interval</span>(
      lubridate::<span class="kw">ymd_hm</span>(<span class="st">"2014-04-18 10:58"</span>), 
      lubridate::<span class="kw">ymd_hm</span>(<span class="st">"2014-04-18 21:18"</span>)
    ),
    lubridate::<span class="kw">interval</span>(
      lubridate::<span class="kw">ymd_hm</span>(<span class="st">"2014-04-21 12:46"</span>), 
      lubridate::<span class="kw">ymd_hm</span>(<span class="st">"2014-04-21 16:30"</span>)
    )
  )
) </code></pre></div>
</div>
<div id="create-a-testing-environment" class="section level2">
<h2 class="hasAnchor">
<a href="#create-a-testing-environment" class="anchor"></a>Create a Testing Environment</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">testdir &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"extdata"</span>, <span class="dt">package =</span> <span class="st">"kwb.monitoring"</span>)
<span class="kw">stopifnot</span>(testdir !=<span class="st"> ""</span>)
rawdir &lt;-<span class="st"> </span>kwb.utils::<span class="kw">createDirectory</span>(<span class="kw">file.path</span>(testdir, <span class="st">"rawdata"</span>))
<span class="co">#&gt; The directory "/home/hauke/R/i686-pc-linux-gnu-library/3.3/kwb.monitoring/extdata/rawdata" was created.</span></code></pre></div>
</div>
<div id="configure-the-script" class="section level2">
<h2 class="hasAnchor">
<a href="#configure-the-script" class="anchor"></a>Configure the Script</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Main Configuration -----------------------------------------------------------</span>
settings &lt;-<span class="st"> </span><span class="kw"><a href="../reference/configure.html">configure</a></span>(
  
  <span class="co"># Where is the "root" directory to raw data?</span>
  <span class="dt">rawdir =</span> rawdir,
  
  <span class="co"># which station?</span>
  <span class="dt">station =</span> <span class="st">"ALT"</span>, <span class="co"># "NEU"</span>
  
  <span class="co"># "left", "centre" or "right" </span>
  <span class="dt">sampleEventMethod =</span> <span class="st">"centre"</span>,
  
  <span class="co"># either "interpolate" or "predict"</span>
  <span class="co"># note the regressionSettings -&gt; predict is only used for the intervals set </span>
  <span class="co"># in "usage", otherwise interpolate will be used</span>
  <span class="dt">replaceMissingQMethod =</span> <span class="st">"interpolate"</span>, 
  
  <span class="co"># which bottles are to be considered (read from the sampler file)?</span>
  <span class="dt">bottlesToConsider =</span> <span class="ot">NA</span>, <span class="co"># NA means: all bottles</span>
  <span class="co">#bottlesToConsider = 1:4,</span>
  
  <span class="co"># which bottles are to be discarded (because they are not full)?</span>
  <span class="dt">bottlesToDiscard =</span> <span class="ot">NA</span>,
  <span class="co">#bottlesToDiscard = 7,</span>
  
  <span class="co"># sample volume (in mL) given to the bottle representing the time </span>
  <span class="co"># interval with highest flow volume</span>
  <span class="dt">Vbottle =</span> <span class="dv">1600</span>, 
  
  <span class="co"># maximum total volume for mixed sample, in mL</span>
  <span class="dt">Vmax =</span> <span class="dv">5000</span>,
  
  <span class="co"># What are the level thresholds (in m) that trigger the start of the sampler?</span>
  <span class="dt">Hthresholds =</span> <span class="kw">c</span>(<span class="dt">ALT=</span><span class="fl">0.055</span>, <span class="dt">NEU=</span><span class="fl">0.05</span>),
  
  <span class="co"># What are the level thresholds (in l/s) that can define the start of an event?</span>
  <span class="dt">Qthresholds =</span> <span class="kw">c</span>(<span class="dt">ALT=</span><span class="dv">3</span>, <span class="dt">NEU=</span><span class="fl">2.5</span>), 
  
  <span class="co"># What are the minimum volumes that are to be considered in the plots?</span>
  <span class="dt">Vthresholds =</span> <span class="kw">c</span>(<span class="dt">ALT=</span><span class="dv">50</span>, <span class="dt">NEU=</span><span class="dv">32</span>), 
  
  <span class="co"># time step in hydraulic data</span>
  <span class="co">#tstep.s = 120, still needed?  </span>
  
  <span class="dt">tstep.fill.s =</span> <span class="dv">120</span>,
  
  <span class="co"># separation of events (how long in seconds may Hthreshold be underrun </span>
  <span class="co"># within an event?)</span>
  <span class="dt">evtSepTime =</span> <span class="dv">4</span>*<span class="dv">3600</span>, <span class="co"># in seconds, here: 4 hours</span>
  
  <span class="co"># separation of sampled events within one and the same sampler file.</span>
  <span class="co"># If the difference between two sample times is greater than this time </span>
  <span class="co"># (in seconds) two sampled events are distinguished. Set to NA to prevent</span>
  <span class="co"># splitting of sampled events.  </span>
  <span class="dt">sampleEventSeparationTime =</span> <span class="dv">4</span>*<span class="dv">3600</span>, <span class="co"># NA, # 3600</span>
  
  <span class="co"># minimum duration (in minutes) of hydraulic events to be considered</span>
  <span class="dt">durationThreshold =</span> <span class="dv">10</span>, <span class="co"># min</span>
  
  <span class="co"># separator to be used in output files (csv)</span>
  <span class="dt">outsep =</span> <span class="st">";"</span>,
  
  <span class="co"># decimal character to be used in output files (csv)</span>
  <span class="dt">outdec =</span> <span class="st">","</span>,
  
  <span class="co"># time interval in seconds for rain data aggregation, e.g. 600 = 10 minutes  </span>
  <span class="co"># NA = no aggregation of original rain data  </span>
  <span class="dt">rain.aggregation.interval =</span> <span class="dv">600</span>
)

<span class="co"># Set the path to a path dictionary file</span>
dictionaryFile &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"extdata/pathDictionary.txt"</span>, <span class="dt">package =</span> <span class="st">"kwb.monitoring"</span>)
  
<span class="co"># Read the path dictionary. The dictionary describes paths, file names and file</span>
<span class="co"># name patterns in the form of a "grammar". By using the dictioanry keywords can</span>
<span class="co"># be resolved to full paths.</span>
dictionary &lt;-<span class="st"> </span><span class="kw"><a href="../reference/pathDictionary.html">pathDictionary</a></span>(
  <span class="dt">dictionaryFile =</span> dictionaryFile,
  <span class="dt">RAW_DIR =</span> settings$rawdir,
  <span class="dt">STATION =</span> settings$station
)

<span class="co"># Assign the path dictionary to the main settings. </span>
settings$dictionary &lt;-<span class="st"> </span>dictionary

<span class="co"># Make the event settings and regression settings part of the main settings</span>
settings$event =<span class="st"> </span>eventSettings
settings$regression =<span class="st"> </span>regressionSettings

<span class="co"># Define the path to a .RData file containing rain data</span>
rainDataFile &lt;-<span class="st"> </span><span class="kw">file.path</span>(settings$rawdir, <span class="st">".."</span>, <span class="st">"RData"</span>, <span class="st">"data_rain.RData"</span>)</code></pre></div>
</div>
</div>
<div id="provide-create-a-testing-environment" class="section level1">
<h1 class="hasAnchor">
<a href="#provide-create-a-testing-environment" class="anchor"></a>Provide Create a Testing Environment</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Create a test directory structure for raw data</span>
flow_dir &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getOrCreatePath.html">getOrCreatePath</a></span>(<span class="st">"FLOW_DIR"</span>, dictionary)

last_flow_dir &lt;-<span class="st"> </span>kwb.utils::<span class="kw">createDirectory</span>(<span class="kw">file.path</span>(flow_dir, <span class="st">"20180601"</span>))
<span class="co">#&gt; The parent directory /home/hauke/R/i686-pc-linux-gnu-library/3.3/kwb.monitoring/extdata/rawdata/test-project/KWB/flows needs to be created first.</span>
<span class="co">#&gt; The parent directory /home/hauke/R/i686-pc-linux-gnu-library/3.3/kwb.monitoring/extdata/rawdata/test-project/KWB needs to be created first.</span>
<span class="co">#&gt; The parent directory /home/hauke/R/i686-pc-linux-gnu-library/3.3/kwb.monitoring/extdata/rawdata/test-project needs to be created first.</span>
<span class="co">#&gt; The directory "/home/hauke/R/i686-pc-linux-gnu-library/3.3/kwb.monitoring/extdata/rawdata/test-project" was created.</span>
<span class="co">#&gt; The directory "/home/hauke/R/i686-pc-linux-gnu-library/3.3/kwb.monitoring/extdata/rawdata/test-project/KWB" was created.</span>
<span class="co">#&gt; The directory "/home/hauke/R/i686-pc-linux-gnu-library/3.3/kwb.monitoring/extdata/rawdata/test-project/KWB/flows" was created.</span>
<span class="co">#&gt; The directory "/home/hauke/R/i686-pc-linux-gnu-library/3.3/kwb.monitoring/extdata/rawdata/test-project/KWB/flows/20180601" was created.</span>

file &lt;-<span class="st"> </span><span class="kw">file.path</span>(last_flow_dir, <span class="st">"flows.csv"</span>)

<span class="kw">writeLines</span>(<span class="dt">con =</span> file, <span class="kw">c</span>(
  <span class="st">"NIVUS"</span>,
  <span class="st">"CPU32"</span>,
  <span class="st">"Datum"</span>,
  <span class="st">"Fenster min"</span>,
  <span class="st">"Fenster max"</span>,
  <span class="kw">paste0</span>(<span class="st">"skip_"</span>, <span class="dv">6</span>:<span class="dv">8</span>),
  <span class="st">"Datum</span><span class="ch">\t</span><span class="st">Uhrzeit</span><span class="ch">\t</span><span class="st">H</span><span class="ch">\t</span><span class="st">v</span><span class="ch">\t</span><span class="st">Q</span><span class="ch">\t</span><span class="st">T"</span>,
  <span class="st">"01.06.2018</span><span class="ch">\t</span><span class="st">00:00:00</span><span class="ch">\t</span><span class="st">0.1</span><span class="ch">\t</span><span class="st">0.1</span><span class="ch">\t</span><span class="st">0.1</span><span class="ch">\t</span><span class="st">0.1"</span>, 
  <span class="st">"01.06.2018</span><span class="ch">\t</span><span class="st">00:01:00</span><span class="ch">\t</span><span class="st">0.2</span><span class="ch">\t</span><span class="st">0.1</span><span class="ch">\t</span><span class="st">0.1</span><span class="ch">\t</span><span class="st">0.1"</span>,
  <span class="st">"01.06.2018</span><span class="ch">\t</span><span class="st">00:02:00</span><span class="ch">\t</span><span class="st">0.3</span><span class="ch">\t</span><span class="st">0.1</span><span class="ch">\t</span><span class="st">0.1</span><span class="ch">\t</span><span class="st">0.1"</span>, 
  <span class="st">"01.06.2018</span><span class="ch">\t</span><span class="st">00:03:00</span><span class="ch">\t</span><span class="st">0.2</span><span class="ch">\t</span><span class="st">0.1</span><span class="ch">\t</span><span class="st">0.1</span><span class="ch">\t</span><span class="st">0.1"</span>,
  <span class="st">"01.06.2018</span><span class="ch">\t</span><span class="st">00:04:00</span><span class="ch">\t</span><span class="st">0.1</span><span class="ch">\t</span><span class="st">0.1</span><span class="ch">\t</span><span class="st">0.1</span><span class="ch">\t</span><span class="st">0.1"</span>, 
  <span class="st">"01.06.2018</span><span class="ch">\t</span><span class="st">00:05:00</span><span class="ch">\t</span><span class="st">0.0</span><span class="ch">\t</span><span class="st">0.1</span><span class="ch">\t</span><span class="st">0.1</span><span class="ch">\t</span><span class="st">0.1"</span>
))

kwb.utils::<span class="kw">createDirectory</span>(<span class="kw"><a href="../reference/getOrCreatePath.html">getOrCreatePath</a></span>(<span class="st">"SAMPLE_DIR"</span>, dictionary))
<span class="co">#&gt; The directory "/home/hauke/R/i686-pc-linux-gnu-library/3.3/kwb.monitoring/extdata/rawdata/test-project/KWB/samples" was created.</span>
<span class="co">#&gt; [1] "/home/hauke/R/i686-pc-linux-gnu-library/3.3/kwb.monitoring/extdata/rawdata/test-project/KWB/samples"</span></code></pre></div>
</div>
<div id="user-defined-functions" class="section level1">
<h1 class="hasAnchor">
<a href="#user-defined-functions" class="anchor"></a>User defined functions</h1>
<p>Before we start, we need to define some helper functions. The following functions are defined:</p>
<ul>
<li><p><code>read_hydraulics</code> reads the hydraulic data (water level and flow). It finds all the needed information on monitoring station and paths in the <code>settings</code> given as the only parameter.</p></li>
<li><p><code>getCurrentFlowSubDirectory</code> is a helper function used by <code>read_hydraulics</code>. It finds the flow subfolder containing the most current data, identified by sorting subfolder names, in our case representing the date in “yyyymmdd” format, decreasingly.</p></li>
<li><p><code>readSamplerFile</code> provides a data frame containing the information on when samples were taken into which bottle, considering the numbers of the bottles to be considered (you may e.g. want to consider only bottles with an even or odd number).</p></li>
<li><p><code>rainGaugesCorrelatedWithStation</code> returns for a given monitoring station a vector of names of rain gauges that have been found to measure rain heights correlating with the discharge volume measured at the monitoring station.</p></li>
<li><p><code>processSampleEvent</code> defines how to proceed during the analysis of one so called “sample event”. With sample event we mean the time limits that are logged by the auto sampler that is triggered by the measured water level.</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># read_hydraulics --------------------------------------------------------------</span>
read_hydraulics &lt;-<span class="st"> </span>function(settings)
{
  flowDirectory &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getOrCreatePath.html">getOrCreatePath</a></span>(<span class="st">"FLOW_DIR"</span>, <span class="dt">dictionary =</span> settings$dictionary)
  
  flowSubdirCurrent &lt;-<span class="st"> </span><span class="kw">getCurrentFlowSubDirectory</span>(flowDirectory)
  
  csv &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getOrCreatePath.html">getOrCreatePath</a></span>(
    <span class="st">"FLOW_CSV"</span>, 
    <span class="dt">dictionary =</span> settings$dictionary, 
    <span class="dt">FLOW_SUBDIR_CURRENT =</span> flowSubdirCurrent
  )
  
  hydraulics &lt;-<span class="st"> </span>kwb.logger::<span class="kw">readLogger_NIVUS_PCM4_2</span>(kwb.utils::<span class="kw">safePath</span>(csv))
  
  renames &lt;-<span class="st"> </span><span class="kw">list</span>(
    <span class="dt">myDateTime =</span> <span class="st">"DateTime"</span>,
    <span class="dt">Fuellstand_m =</span> <span class="st">"H"</span>,
    <span class="dt">Geschw_m_s =</span> <span class="st">"v"</span>,
    <span class="dt">Durchfluss_l_s =</span> <span class="st">"Q"</span>,
    <span class="dt">T_.C =</span> <span class="st">"T"</span>
  )
  
  columnNames &lt;-<span class="st"> </span><span class="kw">as.character</span>(renames)
  
  hydraulics &lt;-<span class="st"> </span>kwb.utils::<span class="kw">selectColumns</span>(
    kwb.utils::<span class="kw">renameColumns</span>(hydraulics, renames), 
    columnNames
  )
  
  hydraulics$DateTime &lt;-<span class="st"> </span><span class="kw">as_utc</span>(hydraulics$DateTime)
  
  hydraulics
  ### data frame with columns "DateTime" (POSIXct, UTC), "H",
  ### "v", "Q", "T"
}

<span class="co"># getCurrentFlowSubDirectory ---------------------------------------------------</span>
getCurrentFlowSubDirectory &lt;-<span class="st"> </span>function
(
  flowDirectory
)
{
  subDirectories &lt;-<span class="st"> </span><span class="kw">dir</span>(flowDirectory)
  
  patternSubdir &lt;-<span class="st"> "^</span><span class="ch">\\</span><span class="st">d{8}$"</span>
  unexpected &lt;-<span class="st"> </span><span class="kw">grep</span>(patternSubdir, subDirectories, <span class="dt">value=</span><span class="ot">TRUE</span>, <span class="dt">invert=</span><span class="ot">TRUE</span>)
  
  if (!<span class="st"> </span>kwb.utils::<span class="kw">isNullOrEmpty</span>(unexpected)) {
    <span class="kw">stop</span>(
      <span class="kw">sprintf</span>(<span class="st">"There are unexpected files/folders in </span><span class="ch">\"</span><span class="st">%s</span><span class="ch">\"</span><span class="st">: %s</span><span class="ch">\n</span><span class="st">%s</span><span class="ch">\n</span><span class="st">"</span>,
              flowDirectory, <span class="kw">paste</span>(kwb.utils::<span class="kw">hsQuoteChr</span>(unexpected)), 
              <span class="st">"Only folders of type 'YYYYMMDD' expected!"</span>)
    )
  }
  
  currentSubdir &lt;-<span class="st"> </span><span class="kw">sort</span>(<span class="kw">setdiff</span>(subDirectories, unexpected), <span class="dt">decreasing=</span><span class="ot">TRUE</span>)[<span class="dv">1</span>]
  
  if (<span class="kw">is.na</span>(currentSubdir)) {
    <span class="kw">warning</span>(<span class="st">"There is no subdirectory 'YYYYMMDD' in "</span>, flowDirectory)
  }
  else {
    <span class="kw">cat</span>(<span class="st">"Most recent flow sub-directory:"</span>, currentSubdir, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
  }  
  
  <span class="kw">return</span>(currentSubdir)
}

<span class="co"># readSamplerFile --------------------------------------------------------------</span>
readSamplerFile &lt;-<span class="st"> </span>function 
(
  samplerFile, bottlesToConsider, <span class="dt">siteCode =</span> <span class="ot">NA</span>
)  
{
  <span class="kw">cat</span>(<span class="kw">sprintf</span>(<span class="st">"Reading sample data from </span><span class="ch">\"</span><span class="st">%s</span><span class="ch">\"</span><span class="st">... "</span>, <span class="kw">basename</span>(samplerFile)))
  
  if (<span class="kw">containsNulString</span>(samplerFile)) {
    <span class="kw">cat</span>(<span class="st">"skipped!</span><span class="ch">\n</span><span class="st">"</span>)
    <span class="kw">warning</span>(<span class="kw">paste</span>(
      <span class="kw">sprintf</span>(
        <span class="st">"File </span><span class="ch">\"</span><span class="st">%s</span><span class="ch">\"</span><span class="st"> contains null string and is skipped!"</span>,
        <span class="kw">basename</span>(samplerFile)),
      <span class="st">"Remove first two bytes of the file!"</span>))
    sampleDataExtended &lt;-<span class="st"> </span><span class="ot">NULL</span>
  }
  else {    
    sampleData &lt;-<span class="st"> </span>kwb.logger::<span class="kw">readLogger_SIGMA_SD900</span>(samplerFile)
    <span class="kw">cat</span>(<span class="st">"ok.</span><span class="ch">\n</span><span class="st">"</span>)
    sampleSite &lt;-<span class="st"> </span><span class="kw">attr</span>(sampleData, <span class="st">"metadata"</span>)$SITE_ID
    
    if (!<span class="kw">is.na</span>(siteCode) &amp;&amp;<span class="st"> </span>sampleSite !=<span class="st"> </span>siteCode) {
      <span class="kw">stop</span>(<span class="kw">sprintf</span>(<span class="st">"The SITE_ID indicated in </span><span class="ch">\"</span><span class="st">%s</span><span class="ch">\"</span><span class="st"> is not </span><span class="ch">\"</span><span class="st">%s</span><span class="ch">\"</span><span class="st"> as expected!"</span>,
                   sampleSite, siteCode))
    }
    
    sampleDataExtended &lt;-<span class="st"> </span><span class="kw">cbind</span>(
      <span class="dt">samplerFile =</span> <span class="kw">basename</span>(samplerFile), 
      sampleData, 
      <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>
    )
  }
  
  <span class="co"># filter for relevant bottles</span>
  if (!<span class="kw">is.null</span>(bottlesToConsider) &amp;<span class="st"> </span>
<span class="st">        </span>!<span class="st"> </span><span class="kw">all</span>(<span class="kw">is.na</span>(bottlesToConsider))) {
    <span class="kw">cat</span>(<span class="st">"Filtering for bottles"</span>, <span class="kw">commaCollapsed</span>(bottlesToConsider), <span class="st">"... "</span>)
    indices &lt;-<span class="st"> </span><span class="kw">which</span>(sampleDataExtended$bottle %in%<span class="st"> </span>bottlesToConsider)
    sampleDataExtended &lt;-<span class="st"> </span>sampleDataExtended[indices, ]
    <span class="kw">cat</span>(<span class="st">"ok.</span><span class="ch">\n</span><span class="st">"</span>)
  }
  
  kwb.utils::<span class="kw">renameColumns</span>(sampleDataExtended, <span class="kw">list</span>(<span class="dt">myDateTime =</span> <span class="st">"sampleTime"</span>))
}

<span class="co"># rainGaugesCorrelatedWithStation ----------------------------------------------</span>
rainGaugesCorrelatedWithStation &lt;-<span class="st"> </span>function 
### selects gauges after the result of the volume correlation test
(
  <span class="dt">station =</span> <span class="ot">NULL</span>
)
{
  x &lt;-<span class="st"> </span><span class="kw">list</span>(
    <span class="dt">ALT =</span> <span class="kw">c</span>(<span class="st">"ReiI"</span>, <span class="st">"BlnXI"</span>, <span class="st">"BlnIX"</span>, <span class="st">"BlnX"</span>),
    <span class="dt">NEU =</span> <span class="kw">c</span>(<span class="st">"Wit"</span>, <span class="st">"ReiI"</span>, <span class="st">"BlnIX"</span>)    
  )
  
  if (!<span class="kw">is.null</span>(station)) {
    x &lt;-<span class="st"> </span>x[[station]]
  } 
  
  x
  ### list (one list element per monitoring site) of character vectors 
  ### representing rain gauge names
}

<span class="co"># processSampleEvent -----------------------------------------------------------</span>
processSampleEvent &lt;-<span class="st"> </span>function
(
  hydraulicData, 
  settings, 
  events, 
  eventsAndStat, 
  <span class="dt">sampleEventIndex =</span> -<span class="dv">1</span>, 
  <span class="dt">to.pdf =</span> <span class="ot">TRUE</span>,
  <span class="dt">verbose =</span> <span class="ot">FALSE</span>
) 
{  
  <span class="kw">stopifnot</span>(<span class="kw">length</span>(sampleEventIndex) ==<span class="st"> </span><span class="dv">1</span>)
  
  <span class="co"># Filter for sampler event by index</span>
  fileName &lt;-<span class="st"> </span><span class="kw">getByPositiveOrNegativeIndex</span>(
    <span class="dt">elements =</span> <span class="kw">sort</span>(<span class="kw">unique</span>(events$samplerEvents$samplerFile)), 
    <span class="dt">index =</span> sampleEventIndex
  ) 
  
  sampleInformation &lt;-<span class="st"> </span><span class="kw"><a href="../reference/filterSampleEventsForFilename.html">filterSampleEventsForFilename</a></span>(
    <span class="dt">events =</span> events, 
    <span class="dt">fileName =</span> fileName
  )  
  
  samplerEvent &lt;-<span class="st"> </span>sampleInformation$samplerEvents
  
  if (verbose) {
    <span class="kw"><a href="../reference/printSampleInformation.html">printSampleInformation</a></span>(sampleInformation)
  }
  
  <span class="kw"><a href="../reference/saveSampleInformation.html">saveSampleInformation</a></span>(sampleInformation, settings, <span class="dt">sampleFile=</span>samplerEvent$samplerFile)
  
  <span class="co"># find "merged" event(s) containing the "sampler event"</span>
  mergedEventNumber &lt;-<span class="st"> </span><span class="kw">indicesOfEventsContainingEvent</span>(eventsAndStat$merged, samplerEvent)
  
  <span class="kw">stopifnot</span>(<span class="kw">length</span>(mergedEventNumber) ==<span class="st"> </span><span class="dv">1</span>)
  
  mergedEventAndStat &lt;-<span class="st"> </span>eventsAndStat$merged[mergedEventNumber, ]
  
  <span class="co"># select subset of data within the sampler event</span>
  hydraulicSubset &lt;-<span class="st"> </span><span class="kw">hsGetEvent</span>(hydraulicData, <span class="dt">events =</span> mergedEventAndStat, <span class="dv">1</span>)
  
  if (kwb.utils::<span class="kw">isNullOrEmpty</span>(hydraulicSubset)) {
    <span class="kw">warning</span>(<span class="st">"There is no hydraulic data for this event:</span><span class="ch">\n</span><span class="st">"</span>, 
            <span class="kw"><a href="../reference/formatEvent.html">formatEvent</a></span>(mergedEventAndStat))
    <span class="kw">return</span>()
  }
  
  <span class="co"># generate a column containing the bottle number for each timestep  </span>
  hydraulicSubset$bottle &lt;-<span class="st"> </span><span class="kw">hsEventNumber</span>(
    hydraulicSubset$DateTime, 
    <span class="dt">events =</span> sampleInformation$bottleEvents,
    <span class="dt">eventNumbers=</span>sampleInformation$bottleEvents$bottle
  )
  
  <span class="co"># generate a column containing the cumulative volume</span>
  hydraulicSubset$Vcum_m3 &lt;-<span class="st"> </span><span class="kw">cumsum</span>(hydraulicSubset$Q)*settings$tstep.fill.s/<span class="dv">1000</span>
  
  <span class="co"># write interpolated data to files for "quality assurance"</span>
  eventName &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sampleLogFileToSampleName.html">sampleLogFileToSampleName</a></span>(samplerEvent$samplerFile)
  
  <span class="kw"><a href="../reference/writeCsvToPathFromDictionary.html">writeCsvToPathFromDictionary</a></span>(
    <span class="dt">dataFrame =</span> hydraulicSubset, 
    <span class="dt">key =</span> <span class="st">"SAMPLED_EVENT_CSV_HYDRAULICS"</span>, 
    <span class="dt">SAMPLED_EVENT_NAME =</span> eventName, 
    <span class="dt">settings =</span> settings, 
    <span class="dt">open.directory =</span> <span class="ot">FALSE</span>
  )
  
  <span class="co"># calculate sum of flows per bottle  </span>
  volumeCompositeSample &lt;-<span class="st"> </span><span class="kw"><a href="../reference/calculateVolumeCompositeSample.html">calculateVolumeCompositeSample</a></span>(  
    hydraulicSubset, settings
  )
  
  <span class="kw"><a href="../reference/writeCsvToPathFromDictionary.html">writeCsvToPathFromDictionary</a></span>(
    <span class="dt">dataFrame =</span> <span class="kw"><a href="../reference/addSumRow.html">addSumRow</a></span>(volumeCompositeSample), 
    <span class="dt">key =</span> <span class="st">"SAMPLED_EVENT_CSV_COMPOSITE"</span>, 
    <span class="dt">SAMPLED_EVENT_NAME =</span> eventName,
    <span class="dt">settings =</span> settings, 
    <span class="dt">open.directory =</span> <span class="ot">FALSE</span>
  )
  
  <span class="kw"><a href="../reference/plot_sampled_event.html">plot_sampled_event</a></span>(
    <span class="dt">hydraulicData =</span> hydraulicData,
    <span class="dt">settings =</span> settings, 
    <span class="dt">sampleInformation =</span> sampleInformation, 
    <span class="dt">mergedEventAndStat =</span> mergedEventAndStat,
    <span class="dt">volumeCompositeSample =</span> volumeCompositeSample,
    <span class="dt">to.pdf =</span> to.pdf
  )  
}</code></pre></div>
</div>
<div id="script-i-data-visualisation-and-composite-sample-calculation" class="section level1">
<h1 class="hasAnchor">
<a href="#script-i-data-visualisation-and-composite-sample-calculation" class="anchor"></a>Script I: Data Visualisation and Composite Sample Calculation</h1>
<p>After having done all the configuration above you may run the main script that is printed in the following. The following steps of which some are optional, are performed:</p>
<ul>
<li><p>loading raw data (water level, flow) from csv files into <code>hydraulicData.raw</code>,</p></li>
<li><p>writing raw data (no meta data, exacly one header line) to a CSV file (optional),</p></li>
<li><p>generating a plot (by default in a PDF file that will be opened) showing the complete timeseries of hydraulic data and one plot per day,</p></li>
<li><p>providing “valid” data in <code>hydraulicData.all</code> by filling gaps in the raw data,</p></li>
<li><p>writing validated data to a CSV file (optional),</p></li>
<li><p>removing data from user-defined time intervals containing “invalid” data,</p></li>
<li><p>building different kinds of <code>events</code> (hydraulic = defined by H and Q, sampling = defined by the sampling times, merged = overlay of hydraulic events and sampling events),</p></li>
<li><p>generating a plot showing the event limits of hydraulic, sampling and merged events,</p></li>
<li><p>writing event data to files (optional),</p></li>
<li><p>adding hydraulic statistics (such as Qmax, discharge volume) as new columns to the tables of events, resulting in <code>eventsAndStat</code>,</p></li>
<li><p>writing event statistics to CSV files (optional),</p></li>
<li><p>loading rain data from an .RData file (optional),</p></li>
<li><p>filtering for events with a minimum discharge volume,</p></li>
<li><p>generating a plot (by default in a PDF file that will be opened) showing an overview of hydraulic events and one page showing level, discharge, rain (optional) and the event statistics per event,</p></li>
<li><p>finally calculating and visualising the shares of volumes that need to be taken from each bottle in order to create a volume-proportional composite sample, i.e. a composite sample in which concentrations are weighted with the discharge volumes that have been calculated for the time intervals that are represented by the different bottles.</p></li>
</ul>
<p>And here comes the script:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Read last available hydraulic data (required if station changed)</span>
<span class="co"># "-10d" = last 10 days</span>
hydraulicData.raw &lt;-<span class="st"> </span>kwb.base::<span class="kw">selectTimeInterval</span>(
  <span class="kw">read_hydraulics</span>(settings), <span class="dt">width =</span> <span class="st">"-30d"</span>
)
<span class="co">#&gt; Most recent flow sub-directory: 20180601 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; *** selectTimeInterval: t1=2018-05-02 00:05:00, t2=2018-06-01 00:05:00, width=-30d</span>

<span class="kw"><a href="../reference/writeCsvToPathFromDictionary.html">writeCsvToPathFromDictionary</a></span>(
  hydraulicData.raw, <span class="dt">key =</span> <span class="st">"HYDRAULIC_DATA_RAW"</span>, settings, 
  <span class="dt">open.directory =</span> <span class="ot">FALSE</span>
)
<span class="co">#&gt; Writing to '/home/hauke/R/i686-pc-linux-gnu-library/3.3/kwb.monitoring/extdata/rawdata/flows_raw.csv'... ok.</span>

<span class="co"># Show overview plots (complete and daily), optional</span>
<span class="kw"><a href="../reference/showOverview.html">showOverview</a></span>(
  hydraulicData.raw, settings, <span class="dt">Qmax =</span> <span class="dv">20</span>, <span class="dt">Hmax =</span> <span class="dv">35</span>, <span class="dt">to.pdf =</span> <span class="ot">TRUE</span>, 
  <span class="dt">save.pdf =</span> <span class="ot">TRUE</span>
)

<span class="co"># Prepare hydraulic data (fill gaps, interpolate/predict)</span>
hydraulicData.all &lt;-<span class="st"> </span><span class="kw"><a href="../reference/validateAndFillHydraulicData.html">validateAndFillHydraulicData</a></span>(
  <span class="dt">hydraulicData =</span> hydraulicData.raw, 
  <span class="dt">settings =</span> settings
)
<span class="co">#&gt; There are 2 timestamps (out of a total of 5 ) that are not multiples of the timestep ( 120 seconds ):</span>
<span class="co">#&gt; [1] "2018-06-01 00:01:00 CEST" "2018-06-01 00:03:00 CEST"</span>
<span class="co">#&gt; replaceMissingQMethod = interpolate -&gt; The interpolated values are used when Q.raw is NA.</span>

<span class="co"># Write data to file (optional)</span>
<span class="kw"><a href="../reference/writeCsvToPathFromDictionary.html">writeCsvToPathFromDictionary</a></span>(
  hydraulicData.all, <span class="dt">key =</span> <span class="st">"HYDRAULIC_DATA_VAL"</span>, settings, 
  <span class="dt">open.directory =</span> <span class="ot">FALSE</span>
)
<span class="co">#&gt; Writing to '/home/hauke/R/i686-pc-linux-gnu-library/3.3/kwb.monitoring/extdata/rawdata/flows_val.csv'... ok.</span>

hydraulicData &lt;-<span class="st"> </span><span class="kw"><a href="../reference/removeIntervals.html">removeIntervals</a></span>(
  hydraulicData.all, 
  <span class="dt">intervals =</span> intervalsToRemove[[settings$station]]
)

<span class="co"># Build different kinds of events (hydraulic, sample, merged), required</span>
events &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getAllTypesOfEvents.html">getAllTypesOfEvents</a></span>(
  hydraulicData, settings, <span class="dt">FUN.readSamplerFile =</span> readSamplerFile
)
<span class="co">#&gt; Warning in getHydraulicEvents(hydraulicData, settings): *** The event conditions are never met.</span>
<span class="co">#&gt;   Range of Q values: [0.100000, 0.100000]</span>
<span class="co">#&gt;   Range of H values: [0.100000, 0.300000]</span>
<span class="co">#&gt;   Q-threshold: 3.000000</span>
<span class="co">#&gt;   H-threshold: 0.055000</span>
<span class="co">#&gt; Warning: There are no hydraulic events according to the defined criteria</span>
<span class="co">#&gt; (or hydraulicData was NULL)!</span>
<span class="co">#&gt; Warning: There are no sample files (matching "sample_\\d.csv") in:</span>
<span class="co">#&gt;   "/home/hauke/R/i686-pc-linux-gnu-library/3.3/kwb.monitoring/extdata/rawdata/test-project/KWB/samples"</span>
<span class="co">#&gt; Warning: There are no sampling events!</span>
<span class="co">#&gt; Warning: No hydraulicEvents given to getMergedEvents(). Returning</span>
<span class="co">#&gt; samplerEvents.</span>

<span class="co"># Plot overview of event limits (optional)</span>
<span class="co"># plotEventOverview(events[c("hydraulic", "samplerEvents", "merged")], settings)</span>
<span class="co"># </span>
<span class="co"># # Write events to files (optional)</span>
<span class="co"># writeCsvToPathFromDictionary(events$samplingEvents, "SAMPLING_EVENTS", settings, </span>
<span class="co">#                              open.directory = FALSE)</span>
<span class="co"># writeCsvToPathFromDictionary(events$bottleEvents, "BOTTLE_EVENTS", settings, </span>
<span class="co">#                              open.directory = FALSE)</span>
<span class="co"># writeCsvToPathFromDictionary(events$samplerEvents, "SAMPLER_EVENTS", settings, </span>
<span class="co">#                              open.directory = FALSE)</span>
<span class="co"># </span>
<span class="co"># # Add statistics to hydraulic events</span>
<span class="co"># eventsAndStat &lt;- addStatisticsToEvents(events, hydraulicData.all)</span>
<span class="co"># </span>
<span class="co"># # Write event including statistics to file (optional)</span>
<span class="co"># writeCsvToPathFromDictionary(</span>
<span class="co">#   eventsAndStat$hydraulic, "HYDRAULIC_EVENTS", settings, </span>
<span class="co">#   open.directory = FALSE</span>
<span class="co"># )</span>
<span class="co"># </span>
<span class="co"># # Load rain data if available</span>
<span class="co"># if (file.exists(rainDataFile)) {</span>
<span class="co">#   load(rainDataFile)</span>
<span class="co"># } else {</span>
<span class="co">#   rainData &lt;- NULL #(if you dont want to show rain data)    </span>
<span class="co"># }</span>
<span class="co"># </span>
<span class="co"># seriesNames &lt;- rainGaugesCorrelatedWithStation(station = settings$station)</span>
<span class="co"># </span>
<span class="co"># hydraulicEvents &lt;- eventsAndStat$hydraulic</span>
<span class="co"># </span>
<span class="co"># Vt &lt;- settings$Vthresholds[settings$station]</span>
<span class="co"># </span>
<span class="co"># hydraulicEvents &lt;- kwb.utils::renameColumns(</span>
<span class="co">#   hydraulicEvents, list(event = "eventNumber")</span>
<span class="co"># )</span>
<span class="co"># </span>
<span class="co"># # Select events with a minimum volume</span>
<span class="co"># selected &lt;- !is.na(hydraulicEvents$V.m3) &amp; hydraulicEvents$V.m3 &gt; Vt</span>
<span class="co"># events.to.plot &lt;- hydraulicEvents[selected,]</span>
<span class="co"># </span>
<span class="co"># # plot hydraulic events with rain</span>
<span class="co"># plot_hydraulic_events(</span>
<span class="co">#   hydraulicData = hydraulicData, </span>
<span class="co">#   settings = settings, </span>
<span class="co">#   eventsAndStat = events.to.plot,</span>
<span class="co">#   to.pdf = TRUE, </span>
<span class="co">#   rainData = rainData, </span>
<span class="co">#   gauges = seriesNames[1:3]</span>
<span class="co"># )  </span>
<span class="co"># </span>
<span class="co"># # Analyse one sampler event given by its number ("sampleEventIndex")</span>
<span class="co"># # according to the order in the sample log files. By giving a negative index</span>
<span class="co"># # you may choose events from the end (-1 means "last", -2 one before last,</span>
<span class="co"># # etc.)</span>
<span class="co"># processSampleEvent(</span>
<span class="co">#   hydraulicData, settings, events, eventsAndStat, sampleEventIndex = -2, </span>
<span class="co">#   to.pdf = FALSE</span>
<span class="co"># )</span></code></pre></div>
</div>
<div id="script-ii-finding-and-storing-hq-regression-models" class="section level1">
<h1 class="hasAnchor">
<a href="#script-ii-finding-and-storing-hq-regression-models" class="anchor"></a>Script II: Finding and storing H/Q-regression models</h1>
<p>The following script helps you to generate a regression model between water level and discharge values. Raw data are loaded into <code>hydraulicData.raw</code>. Data of time intervals that have been assessed as “invalid” (defined in <code>intervalsToRemove</code>, see above) are removed. The resulting timeseries of H and Q are displayed as well as a plot showing H over Q. You are provided a simple user interface to further manipulate the selection of values to be used to calculate a regression model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Find H-Q regression models ---------------------------------------------------</span>
if (<span class="ot">FALSE</span>) 
{ 
  <span class="co"># Read last available hydraulic data (required if station changed)</span>
  <span class="co"># "-10d" = last 10 days</span>
  hydraulicData.raw &lt;-<span class="st"> </span>kwb.base::<span class="kw">selectTimeInterval</span>(<span class="kw">read_hydraulics</span>(settings), <span class="dt">width=</span><span class="st">"-30d"</span>)
  
  <span class="co">#Remove bad Intervals</span>
  hydraulicData &lt;-<span class="st"> </span><span class="kw"><a href="../reference/removeIntervals.html">removeIntervals</a></span>(
    hydraulicData.raw, 
    <span class="dt">intervals =</span> intervalsToRemove[[settings$station]]
  )
  
  <span class="co"># run "regression finder" with a subset of the raw data</span>
  <span class="kw"><a href="../reference/selectIntervalsForCorrelation.html">selectIntervalsForCorrelation</a></span>(kwb.base::<span class="kw">selectTimeInterval</span>(hydraulicData, <span class="dt">width=</span><span class="st">"-30d"</span>), settings)
  
  <span class="co"># the model last applied is now available in the variable "regresssionState"</span>
  <span class="kw"><a href="../reference/saveRegressionModel.html">saveRegressionModel</a></span>(regressionState$model, settings)
}</code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#install-required-packages">Install Required Packages</a></li>
      <li><a href="#load-kwb-monitoring">Load kwb.monitoring</a></li>
      <li>
<a href="#configuration">Configuration</a><ul class="nav nav-pills nav-stacked">
<li><a href="#define-helper-functions">Define Helper Functions</a></li>
      <li><a href="#define-event-settings">Define Event Settings</a></li>
      <li><a href="#define-regression-settings">Define Regression Settings</a></li>
      <li><a href="#define-time-intervals-to-be-removed">Define Time Intervals to be Removed</a></li>
      <li><a href="#create-a-testing-environment">Create a Testing Environment</a></li>
      <li><a href="#configure-the-script">Configure the Script</a></li>
      </ul>
</li>
      <li><a href="#provide-create-a-testing-environment">Provide Create a Testing Environment</a></li>
      <li><a href="#user-defined-functions">User defined functions</a></li>
      <li><a href="#script-i-data-visualisation-and-composite-sample-calculation">Script I: Data Visualisation and Composite Sample Calculation</a></li>
      <li><a href="#script-ii-finding-and-storing-hq-regression-models">Script II: Finding and storing H/Q-regression models</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Hauke Sonnenberg.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
